<!doctype html><html xmlns=http://www.w3.org/1999/xhtml xml:lang=en lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,maximum-scale=1"><title>Running with Docker &#183; first things first </title><link rel=stylesheet type=text/css href=/css/uno.min.css><link rel=stylesheet href=//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css><link rel=stylesheet type=text/css href=/css/custom.css><link rel=apple-touch-icon sizes=57x57 href=/apple-icon-57x57.png><link rel=apple-touch-icon sizes=60x60 href=/apple-icon-60x60.png><link rel=apple-touch-icon sizes=72x72 href=/apple-icon-72x72.png><link rel=apple-touch-icon sizes=76x76 href=/apple-icon-76x76.png><link rel=apple-touch-icon sizes=114x114 href=/apple-icon-114x114.png><link rel=apple-touch-icon sizes=120x120 href=/apple-icon-120x120.png><link rel=apple-touch-icon sizes=144x144 href=/apple-icon-144x144.png><link rel=apple-touch-icon sizes=152x152 href=/apple-icon-152x152.png><link rel=apple-touch-icon sizes=180x180 href=/apple-icon-180x180.png><link rel=icon type=image/png sizes=192x192 href=/android-icon-192x192.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=96x96 href=/favicon-96x96.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/manifest.json><meta name=msapplication-TileColor content="#ffffff"><meta name=msapplication-TileImage content="/ms-icon-144x144.png"><meta name=theme-color content="#ffffff"><link rel=canonical href=http://www.gordonburgett.net/post/2015/10_running_with_docker/></head><body><span class="mobile btn-mobile-menu"><i class="fa fa-bars btn-mobile-menu__icon"></i>
<i class="fa fa-times btn-mobile-close__icon hidden"></i></span><header class="panel-cover panel-cover--collapsed"><div class=panel-main><div class="panel-main__inner panel-inverted"><div class=panel-main__content><h1 class="panel-cover__title panel-title"><a href=/ title="link to homepage for first things first">first things first</a></h1><hr class=panel-cover__divider><p class=panel-cover__description>A blog about whatever crosses my mind, ordered by importance.</p><hr class="panel-cover__divider panel-cover__divider--secondary"><div class=navigation-wrapper><nav class="cover-navigation cover-navigation--primary"><ul class=navigation><li class=navigation__item><a href=/albania title=Albania class=blog-button>Albania</a></li><br><li class=navigation__item><a href=/search title=Search class=blog-button>Search</a></li><br><li class=navigation__item></li></ul></nav><nav class="cover-navigation navigation--social"><ul class=navigation><br><li class=navigation__item><a href=https://github.com/gburgett title="gburgett on github"><i class='fa fa-github'></i> <span class=label>Github</span></a></li></br><li class=navigation__item><a href=# id=email title=Email><i class='fa fa-envelope-o'></i> <span class=label>Email</span></a></li><br><li class=navigation__item><a href=/pubkey.txt id=gpg title="GPG key"><i class='fa fa-key'></i> <span class=label>GPG key</span></a></li></ul></nav></div></div></div><div class=panel-cover--overlay></div></div></header><div class=content-wrapper><div class=content-wrapper__inner><div class=post><h1>Running with Docker</h1><span class=post-date>Wed, Oct 7, 2015</span><h3 id=locked-out>Locked out!</h3><p>I managed to lock myself out of my EC2 instance when I was managing my keys. So in order to update my blog, I had to deploy it to a new EC2 instance. I decided to take the opportunity to improve the way I&rsquo;m deploying new versions of my site.</p><p>Note: This will be a technical post. If you&rsquo;re following along with my adventure in Albania, you can skip this one.</p><h3 id=docker-for-fun-and-profit>Docker, for fun and profit</h3><p><a href=https://www.docker.com/>Docker</a> is a program which manages &ldquo;containers&rdquo;. A container is it&rsquo;s own isolated system inside a running Linux operating system, separated from other containers and from the main entry point. Docker runs containers from &ldquo;images&rdquo;, which contain all the files, programs, and settings necessary for the main program in a container. It&rsquo;s similar to a lightweight virtual machine.</p><p>I was able to use this to pre-package the environment necessary to run my server. Instead of having to remember how to set up nodeJs, install the npm packages, and run the server, I encoded that in my Dockerfile. The Dockerfile contains instructions to build docker containers.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-dockerfile data-lang=dockerfile><span style=display:flex><span><span style=color:#75715e># Use centos7 as a base for my docker container</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> centos:centos7</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># Enable EPEL to get Node.js</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> yum install -y epel-release<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># Install Node.js and npm</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> yum install -y nodejs npm<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># Install hugo</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> curl -L -o /tmp/hugo.tar.gz https://github.com/spf13/hugo/releases/download/v0.14/hugo_0.14_linux_386.tar.gz<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> tar xvf /tmp/hugo.tar.gz -C /tmp/<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> mv /tmp/hugo_0.14_linux_386/hugo_0.14_linux_386 /usr/bin/hugo<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># Add my npm modules</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> package.json /src/package.json<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> cd /src; npm install<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># Expose ports 8080 and 8081 to outside the docker container</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>EXPOSE</span><span style=color:#e6db74> 8080 8081</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># Set the command to be executed when the docker container is run.</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>CMD</span> [<span style=color:#e6db74>&#34;node&#34;</span>, <span style=color:#e6db74>&#34;/src/node/server.js&#34;</span>, <span style=color:#e6db74>&#34;/src/public&#34;</span>, <span style=color:#e6db74>&#34;8080&#34;</span>, <span style=color:#e6db74>&#34;8081&#34;</span>]<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># Copy my blog into the /src directory and generate the blog output with Hugo</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> ./ /src/<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> hugo -s /src/ --baseUrl<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;http://www.gordonburgett.net&#34;</span><span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p>Now I can run it anywhere that has Docker, and I don&rsquo;t need to worry about installing all my dependencies. They&rsquo;re all already baked in to the image.</p><p>I created a repository on <a href=https://hub.docker.com/r/gordonburgett/blog/>Dockerhub</a> to host my images, so that I can easily pull them down with the web server. Dockerhub has easy integration with Github - all you have to do is link your accounts and you can set up an automatic build whenever you push your code. It also has webhooks - whenever a build completes, it will send a message to any URL you provide. I&rsquo;m using that to build a chain of tools to automatically deploy my blog whenever I push a new version to Github.</p><h3 id=launching-the-new-server>Launching the new server</h3><p>I went to AWS console and fired up a new EC2 instance, using my existing key pair. I decided this time to track everything I did and keep it in a shell script to make it easy to set up a new instance anytime I need. I shouldn&rsquo;t treat my web server like a pet, it&rsquo;s easier to treat it like a head of cattle. When a pet gets sick, you spend a lot of time and effort to nurse it back to health. When a cow gets sick, you slaughter it and buy a new cow.</p><p>My init script looks like this (after much trial and error):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>set -e
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># Read command line parameters ( -i /path/to/identity.pem )</span>
</span></span><span style=display:flex><span>identity<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>while</span> getopts i: opt; <span style=color:#66d9ef>do</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>case</span> $opt in 
</span></span><span style=display:flex><span>  	i<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>		identity<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;-i </span>$OPTARG<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>		;;
</span></span><span style=display:flex><span>	<span style=color:#ae81ff>\?</span><span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>		echo <span style=color:#e6db74>&#34;Invalid option: -</span>$OPTARG<span style=color:#e6db74>&#34;</span> &gt;&amp;<span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>		exit <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>		;;
</span></span><span style=display:flex><span>	:<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>		echo <span style=color:#e6db74>&#34;Option -</span>$OPTARG<span style=color:#e6db74> requires an argument.&#34;</span> &gt;&amp;<span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>		exit <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>		;;
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>esac</span>
</span></span><span style=display:flex><span>  shift <span style=color:#66d9ef>$((</span>OPTIND-1<span style=color:#66d9ef>))</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>done</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>server<span style=color:#f92672>=</span>$1
</span></span><span style=display:flex><span><span style=color:#f92672>[[</span> -z <span style=color:#e6db74>&#34;</span>$server<span style=color:#e6db74>&#34;</span> <span style=color:#f92672>]]</span> <span style=color:#f92672>&amp;&amp;</span> echo <span style=color:#e6db74>&#34;expected server address&#34;</span> <span style=color:#f92672>&amp;&amp;</span> exit -1
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># send over all the files in the &#34;hosting/&#34; folder, including the SSL cert &amp; private key.</span>
</span></span><span style=display:flex><span>rsync -avz -e <span style=color:#e6db74>&#34;ssh </span>$identity<span style=color:#e6db74>&#34;</span> hosting/ ec2-user@$server:~/hosting
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># SSH in to the server and run these commands to configure it:</span>
</span></span><span style=display:flex><span>pubkey<span style=color:#f92672>=</span><span style=color:#e6db74>`</span>cat ~/.ssh/id_rsa.pub<span style=color:#e6db74>`</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>init<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;chmod -R 0700 ~/hosting
</span></span></span><span style=display:flex><span><span style=color:#e6db74>echo \&#34;</span>$pubkey<span style=color:#e6db74>\&#34; &gt;&gt; ~/.ssh/authorized_keys	# Add my key to the authorized key list
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74># Install haproxy and docker
</span></span></span><span style=display:flex><span><span style=color:#e6db74>sudo yum -y install haproxy docker
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74># Configure and start docker
</span></span></span><span style=display:flex><span><span style=color:#e6db74>sudo groupadd docker
</span></span></span><span style=display:flex><span><span style=color:#e6db74>sudo gpasswd -a ec2-user docker
</span></span></span><span style=display:flex><span><span style=color:#e6db74>sudo service docker start
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74># Finally, start haproxy with the synced config file.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>sudo /usr/sbin/haproxy -f /home/ec2-user/hosting/haproxy.conf -D&#34;</span>
</span></span><span style=display:flex><span>ssh -t $identity ec2-user@$server <span style=color:#e6db74>&#34;</span>$init<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e># log out to join the docker group, then ssh back in to start the docker container.</span>
</span></span><span style=display:flex><span>uuid<span style=color:#f92672>=</span><span style=color:#e6db74>`</span>uuidgen<span style=color:#e6db74>`</span>
</span></span><span style=display:flex><span>run<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;docker run --restart=always -d -p 8080:8080 -p 8081:8081 gordonburgett/blog || echo \&#34;already running\&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74># Install docker-hook, a small python web listener which
</span></span></span><span style=display:flex><span><span style=color:#e6db74># restarts docker when it receives a message from Dockerhub.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>curl https://raw.githubusercontent.com/schickling/docker-hook/master/docker-hook &gt; /home/ec2-user/hosting/docker-hook; chmod +x /home/ec2-user/hosting/docker-hook
</span></span></span><span style=display:flex><span><span style=color:#e6db74>nohup /home/ec2-user/hosting/docker-hook -t </span>$uuid<span style=color:#e6db74> -c /bin/bash /home/ec2-user/hosting/update_container.sh &amp;&#34;</span>
</span></span><span style=display:flex><span>ssh -t ec2-user@$server <span style=color:#e6db74>&#34;</span>$run<span style=color:#e6db74>&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#34;Add this to dockerhub hook:&#34;</span>
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#34;http://www.gordonburgett.net:8555/</span>$uuid<span style=color:#e6db74>&#34;</span>
</span></span></code></pre></div><p>I ran that script against a fresh EC2 instance and it fired up my blog! Also, every time I make a new post, I only have to upload it to Github and it&rsquo;s automatically deployed to my web server in less than 10 minutes. Success!</p><h3 id=hooking-up-automatic-notifications>Hooking up automatic notifications</h3><p>I&rsquo;m using MailChimp to manage my email list for my newsletter. It has a ton of great features, even on the free account. One is an automatic campaign which is sent out based on an RSS feed. This is perfect for updating users whenever I post a new blog entry.</p><p>I created a sub-section of my subscribers list based on whether they had opted out of receiving blog updates. There&rsquo;s a new radio dial on the sign-up form that looks like this:</p><div><link href=//cdn-images.mailchimp.com/embedcode/classic-081711.css rel=stylesheet type=text/css><style type=text/css>#mc_embed_signup{background:#fff;clear:left;font:14px Helvetica,Arial,sans-serif}<p></style></p><div id=mc_embed_signup><form name=mc-embedded-subscribe-form class=validate target=_blank novalidate><div id=mc_embed_signup_scroll><div class="mc-field-group input-group"><strong>When my blog is updated:</strong><ul><li><input value="Get an email" name=BLOGUPDATE id=mce-BLOGUPDATE-0 type=radio><label for=mce-BLOGUPDATE-0>Get an email</label></li><li><input value="Don't send anything" name=BLOGUPDATE id=mce-BLOGUPDATE-1 type=radio><label for=mce-BLOGUPDATE-1>Don't send anything</label></li></ul></div></div></form></div></div><p>I set up an automatic campaign to send an email with the content of my most recent blog posts. It checks the RSS feed <a href=/index.xml>here</a> every day at 4am eastern time, and if there&rsquo;s a new post, it sends a message and also posts for me on facebook. Neat, eh?</p><p><img alt="Mailchimp RSS example" src=/images/2015/mailchimp_rss_example.png></p><p>Well, that&rsquo;s it for this adventure in useless stuff I didn&rsquo;t really need to do but had fun doing. See you next time, technical readers!</p></div></div></div></body><link rel=stylesheet href=/js/highlight/styles/vs2015.css><script src=https://code.jquery.com/jquery-2.2.4.min.js integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin=anonymous></script><script src=/js/main.min.js></script><script src=/js/custom.js></script><script src=/js/highlight/highlight.pack.js></script><script>hljs.initHighlightingOnLoad()</script></html>