<!doctype html><html><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="ie=edge"><meta http-equiv=Accept-CH content="DPR, Viewport-Width, Width"><link rel=icon href=/fav.png type=image/gif><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=preload as=style href="https://fonts.googleapis.com/css2?family=Alata&family=Lora:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500;1,600;1,700&family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap"><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=Alata&family=Lora:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500;1,600;1,700&family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap" media=print onload='this.media="all"'><noscript><link href="https://fonts.googleapis.com/css2?family=Alata&family=Lora:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500;1,600;1,700&family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap" rel=stylesheet></noscript><link rel=stylesheet href=/css/font.css media=all><meta property="og:url" content="http://www.gordonburgett.net/archive/2016/02_docker-cloud-is-neat/"><meta property="og:site_name" content="Gordon Burgett | Director of Technology Development"><meta property="og:title" content="Docker Cloud is Neat"><meta property="og:description" content="I had some time off today so I decided to revisit how I’m hosting all my stuff. One of my issues with using Amazon’s container service is that they make you assign resource values to each container, and those are not flexible. So, I have to give each container high enough memory that it won’t die, but then I run out of space on my server real quick. Since most of the stuff I want to host just sits idle the majority of the time, this wasn’t ideal for me."><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="archive"><meta property="article:published_time" content="2016-02-15T14:09:13+01:00"><meta property="article:modified_time" content="2016-02-15T14:09:13+01:00"><meta property="article:tag" content="Development"><meta property="article:tag" content="Docker"><meta name=twitter:card content="summary"><meta name=twitter:title content="Docker Cloud is Neat"><meta name=twitter:description content="I had some time off today so I decided to revisit how I’m hosting all my stuff. One of my issues with using Amazon’s container service is that they make you assign resource values to each container, and those are not flexible. So, I have to give each container high enough memory that it won’t die, but then I run out of space on my server real quick. Since most of the stuff I want to host just sits idle the majority of the time, this wasn’t ideal for me."><link rel=stylesheet href=/bootstrap-5/css/bootstrap.min.css media=all><link rel=stylesheet href=/css/header.css media=all><link rel=stylesheet href=/css/footer.css media=all><link rel=stylesheet href=/css/theme.css media=all><style>:root{--text-color:#343a40;--text-secondary-color:#6c757d;--text-link-color:#007bff;--background-color:#eaedf0;--secondary-background-color:#64ffda1a;--primary-color:#007bff;--secondary-color:#f8f9fa;--text-color-dark:#e4e6eb;--text-secondary-color-dark:#b0b3b8;--text-link-color-dark:#ffffff;--background-color-dark:#18191a;--secondary-background-color-dark:#212529;--primary-color-dark:#ffffff;--secondary-color-dark:#212529}body{font-size:1rem;font-weight:400;line-height:1.5;text-align:left}html{background-color:var(--background-color)!important}body::-webkit-scrollbar{height:0;width:8px;background-color:var(--background-color)}::-webkit-scrollbar-track{border-radius:1rem}::-webkit-scrollbar-thumb{border-radius:1rem;background:#b0b0b0;outline:1px solid var(--background-color)}#search-content::-webkit-scrollbar{width:.5em;height:.1em;background-color:var(--background-color)}</style><link rel=stylesheet href=/css/custom.css type=text/css><script src=https://code.jquery.com/jquery-3.7.1.slim.min.js integrity="sha256-kmHvs0B+OpCW5GVHUNjv9rOmY0IvSIRcf7zGUDTDQM8=" crossorigin=anonymous></script><script src=/js/custom.js type=text/javascript></script><script defer data-domain=gordonburgett.net src=https://plausible.io/js/script.js></script><meta name=description content><link rel=stylesheet href=/css/single.css><script defer src=/fontawesome-6/all-6.4.2.js></script><title>Docker Cloud is Neat | Gordon Burgett | Director of Technology Development</title></head><body class=light><script>let localStorageValue=localStorage.getItem("pref-theme"),mediaQuery=window.matchMedia("(prefers-color-scheme: dark)").matches;switch(localStorageValue){case"dark":document.body.classList.add("dark");break;case"light":document.body.classList.remove("dark");break;default:mediaQuery&&document.body.classList.add("dark");break}</script><header id=profileHeader><nav class="pt-3 navbar navbar-expand-lg animate"><div class="container-fluid mx-xs-2 mx-sm-5 mx-md-5 mx-lg-5"><a class="navbar-brand primary-font text-wrap" href=/>Gordon Burgett
</a><button class=navbar-toggler type=button data-bs-toggle=collapse data-bs-target=#navbarContent aria-controls=navbarContent aria-expanded=false aria-label="Toggle navigation"><svg aria-hidden="true" height="24" viewBox="0 0 16 16" width="24" data-view-component="true"><path fill-rule="evenodd" d="M1 2.75A.75.75.0 011.75 2h12.5a.75.75.0 110 1.5H1.75A.75.75.0 011 2.75zm0 5A.75.75.0 011.75 7h12.5a.75.75.0 110 1.5H1.75A.75.75.0 011 7.75zM1.75 12a.75.75.0 100 1.5h12.5a.75.75.0 100-1.5H1.75z"/></svg></button><div class="collapse navbar-collapse text-wrap primary-font" id=navbarContent><ul class="navbar-nav ms-auto text-center"><li class="nav-item navbar-text"><a class=nav-link href=/#projects aria-label=projects>Projects</a></li><li class="nav-item navbar-text"><a class=nav-link href=/posts title="Blog posts">Blog</a></li><li class="nav-item navbar-text"><a class=nav-link href=/albania title=Albania>Albania</a></li><li class="nav-item navbar-text"><a class=nav-link href=/archive title=Archive>Archive</a></li><li class="nav-item navbar-text"><div class=text-center><button id=theme-toggle><svg id="moon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></li></ul></div></div></nav></header><div id=content><section id=single><div class=container><div class="row justify-content-center"><div class="col-sm-12 col-md-12 col-lg-9"><div class=pr-lg-4><div class="title mb-5"><h1 class="text-center mb-4">Docker Cloud is Neat</h1><div class=text-center>Feb 15, 2016
<span id=readingTime>min read</span></div></div><article class="page-content p-2"><p>I had some time off today so I decided to revisit how I&rsquo;m hosting all my stuff. One of my issues with using Amazon&rsquo;s container service is that they make you assign resource values to each container, and those are not flexible. So, I have to give each container high enough memory that it won&rsquo;t die, but then I run out of space on my server real quick. Since most of the stuff I want to host just sits idle the majority of the time, this wasn&rsquo;t ideal for me.</p><p>I&rsquo;d heard about Tutum before, so I went to check it out. It&rsquo;s another container management solution. It&rsquo;s since been acquired by Docker and rebranded as <a href=https://cloud.docker.com>docker cloud</a>. It&rsquo;s definitely got a slick interface, and looks to provide all the features I&rsquo;ll need. One that I particularly like is the &ldquo;autoredeploy&rdquo; switch, which automatically redeploys a container when you push a new image. Perfect for my blog. So, I set about getting it set up.</p><p><img alt="Docker cloud tour" src=/images/2016/docker-cloud-tour.png>
They have a neat tour! Getting set up with AWS as my service provider was a snap. It spins up its own AWS instances to use as nodes though, which means I can&rsquo;t use my fancy auto-initialization with an auto-scaling group. But, you can also &lsquo;bring your own node&rsquo; by installing the docker-cloud client. Turned out to be pretty simple to incorporate that into my launch script:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e># set up docker cloud</span>
</span></span><span style=display:flex><span>sudo apt-get -y install python-pip
</span></span><span style=display:flex><span>sudo pip install docker-cloud
</span></span><span style=display:flex><span><span style=color:#75715e># the &#39;byo&#39; command prints out a list of instructions, we just need to run the line with the curl command.</span>
</span></span><span style=display:flex><span>docker-cloud node byo | grep <span style=color:#e6db74>&#39;curl&#39;</span> | sh
</span></span><span style=display:flex><span>sudo gpasswd -a ubuntu docker
</span></span></code></pre></div><p>One tricky part was that I couldn&rsquo;t use the Amazon ECS-optimized image, since the docker-cloud client only supports ubuntu. So I had to switch all my initialization stuff over to an ubuntu image. That was a bit of a pain. But, after getting it all set up, my node appeared in the &rsquo;nodes&rsquo; tab on docker cloud!</p><p>Now to set up my services. You can set them up directly using the web interface, but I prefer to have well-defined files somewhere describing my services. Docker cloud has a concept called &lsquo;stacks&rsquo; which are defined by yaml files, similar to docker-compose. This let me link all the dependent services together in a declarative way. I created my &lsquo;blog&rsquo; stack like this:</p><p><img alt="Blog stackfile" src=/images/2016/blog-stack-yaml.png>
Now I need to set up my haproxy load balancer in front of it. I decided this time I&rsquo;ll dockerize my load balancer instead of having it run straight on the EC2 instance. I messed around with it for a long time before I found this image, which does everything I want: <a href=https://hub.docker.com/r/dockercloud/haproxy/>https://hub.docker.com/r/dockercloud/haproxy/</a></p><p>Setting that up was a breeze. I created a service to run it, and set it to listen on ports 80 and 443 (the HTTP and HTTPS ports). It contacts the docker cloud API and discoveres the locations of all my other services automatically, and imports their info into its configuration. I just needed to declare a couple environment variables in my other services, like hostname and SSL keys, and it imports them to route virtual hosts and terminate SSL connections automagically. Sweet!</p><p>Only a couple things tripped me up at this point. One was the routing based on the <code>VIRTUAL_HOST</code> environment variable. If you want it to route https traffic, you need an &ldquo;https://&rdquo; virtual host in there. Another thing was that, while this haproxy service has a DNS hostname, I can&rsquo;t just make a CNAME to it from <a href=https://www.gordonburgett.net>www.gordonburgett.net</a>, since the DNS hostname changes whenever the container is reloaded. So I stuck to my old way of assigning an Elastic IP to the node and using that in my DNS records.</p><h2 id=running-the-reclaimed-site>Running the Reclaimed site</h2><p>One of the things that sparked all this was my attempt to get the Reclaimed site to do automatic nightly backups to aws s3. I modified <a href=https://hub.docker.com/r/yaronr/backup-volume-container/>this docker container</a>, which automatically backs up anything in <code>/var/backup</code> to aws s3, and linked that in to my other two containers. I also had to set up cron tasks in the other two containers to do automated backup and restore to and from <code>/var/backup</code>. That took a while, but I think my solution works well.</p><p>Once I got all that figured out locally, deploying it to docker cloud was pretty simple. Here&rsquo;s my stackfile:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>backup</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>image</span>: <span style=color:#e6db74>&#39;gordonburgett/backup-volume-container:latest&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>command</span>: <span style=color:#e6db74>&#39;s3://s3.amazonaws.com/gordonburgett.net/backup/reclaimed 30&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>environment</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>AWS_ACCESS_KEY_ID=********</span>
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>AWS_SECRET_ACCESS_KEY=********</span>
</span></span><span style=display:flex><span><span style=color:#f92672>db</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>image</span>: <span style=color:#e6db74>&#39;gordonburgett/mongo-locomotive:latest&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>volumes_from</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>backup</span>
</span></span><span style=display:flex><span><span style=color:#f92672>engine</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>image</span>: <span style=color:#e6db74>&#39;gordonburgett/locomotive_engine:latest&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>environment</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>SECRET_KEY_BASE=********</span>
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>VIRTUAL_HOST=reclaimed.gordonburgett.net</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>expose</span>:
</span></span><span style=display:flex><span>    - <span style=color:#e6db74>&#39;8080&#39;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>links</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>db</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>restart</span>: <span style=color:#66d9ef>on</span>-<span style=color:#ae81ff>failure</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>volumes_from</span>:
</span></span><span style=display:flex><span>    - <span style=color:#ae81ff>backup</span>
</span></span></code></pre></div><p>I updated my haproxy service to link to the &ldquo;engine&rdquo; service, and started it up. Now going to &lsquo;reclaimed.gordonburgett.net&rsquo; gets me through the load balancer and into the rails app. Perfect! I uploaded the site, which you can see at <a href=http://reclaimed.gordonburgett.net>http://reclaimed.gordonburgett.net</a></p><p>Here it is!
<img alt="The node with everything running" src=/images/2016/docker-cloud-node.png></p><p>Like I said, neat!</p></article></div></div><div class="col-sm-12 col-md-12 col-lg-3"><div id=stickySideBar class=sticky-sidebar><aside class=toc><h5>Table Of Contents</h5><div class=toc-content><nav id=TableOfContents><ul><li><a href=#running-the-reclaimed-site>Running the Reclaimed site</a></li></ul></nav></div></aside><aside class=tags><h5>Tags</h5><ul class="tags-ul list-unstyled list-inline"><li class=list-inline-item><a href=http://www.gordonburgett.net/tags/development target=_blank>Development</a></li><li class=list-inline-item><a href=http://www.gordonburgett.net/tags/docker target=_blank>docker</a></li></ul></aside><aside class=social><h5>Share</h5><div class=social-content><ul class=list-inline><li class="list-inline-item text-center"><a target=_blank href="https://www.linkedin.com/shareArticle?mini=true&url=http%3a%2f%2fwww.gordonburgett.net%2farchive%2f2016%2f02_docker-cloud-is-neat%2f"><i class="fab fa-linkedin"></i></a></li><li class="list-inline-item text-center"><a target=_blank href="https://twitter.com/share?text=Docker%20Cloud%20is%20Neat&url=http%3a%2f%2fwww.gordonburgett.net%2farchive%2f2016%2f02_docker-cloud-is-neat%2f"><i class="fab fa-twitter"></i></a></li><li class="list-inline-item text-center"><a target=_blank href="https://api.whatsapp.com/send?text=Docker%20Cloud%20is%20Neat: http%3a%2f%2fwww.gordonburgett.net%2farchive%2f2016%2f02_docker-cloud-is-neat%2f"><i class="fab fa-whatsapp"></i></a></li><li class="list-inline-item text-center"><a target=_blank href='mailto:?subject=Docker%20Cloud%20is%20Neat&amp;body=Check%20out%20this%20site http%3a%2f%2fwww.gordonburgett.net%2farchive%2f2016%2f02_docker-cloud-is-neat%2f'><i class="fa fa-envelope"></i></a></li></ul></div></aside></div></div></div><div class=row><div class="col-sm-12 col-md-12 col-lg-9 p-4"></div></div></div><button class="p-2 px-3" onclick=topFunction() id=topScroll>
<i class="fas fa-angle-up"></i></button></section><div class=progress><div id=scroll-progress-bar class=progress-bar role=progressbar aria-valuenow=0 aria-valuemin=0 aria-valuemax=100></div></div><script src=/js/scrollProgressBar.js></script><script>var topScroll=document.getElementById("topScroll");window.onscroll=function(){scrollFunction()};function scrollFunction(){document.body.scrollTop>20||document.documentElement.scrollTop>20?topScroll.style.display="block":topScroll.style.display="none"}function topFunction(){document.body.scrollTop=0,document.documentElement.scrollTop=0}let stickySideBarElem=document.getElementById("stickySideBar"),stickyNavBar=!1;if(stickyNavBar){let e=document.getElementById("profileHeader"),t=e.offsetHeight+15;stickySideBarElem.style.top=t+"px"}else stickySideBarElem.style.top="50px"</script><script src=/js/readingTime.js></script></div><footer><div class="text-center pt-2"></div><div class="container py-4"><div class="row justify-content-center"><div class="col-md-4 text-center">&copy; 2025 All Rights Reserved<div class=text-secondary>Made with
<span class=text-danger>&#10084;
</span>and
<a href=https://github.com/gurusabarish/hugo-profile target=_blank title="Designed and developed by gurusabarish">Hugo Profile</a></div></div></div></div></footer><script src=/bootstrap-5/js/bootstrap.bundle.min.js></script><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))});var tooltipTriggerList=[].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]')),tooltipList=tooltipTriggerList.map(function(e){return new bootstrap.Tooltip(e)})</script><section id=search-content class=py-2><div class=container id=search-results></div></section></body></html>