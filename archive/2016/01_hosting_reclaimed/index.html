<!doctype html><html><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="ie=edge"><meta http-equiv=Accept-CH content="DPR, Viewport-Width, Width"><link rel=icon href=/fav.png type=image/gif><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=preload as=style href="https://fonts.googleapis.com/css2?family=Alata&family=Lora:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500;1,600;1,700&family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap"><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=Alata&family=Lora:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500;1,600;1,700&family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap" media=print onload='this.media="all"'><noscript><link href="https://fonts.googleapis.com/css2?family=Alata&family=Lora:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500;1,600;1,700&family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap" rel=stylesheet></noscript><link rel=stylesheet href=/css/font.css media=all><meta property="og:url" content="http://www.gordonburgett.net/archive/2016/01_hosting_reclaimed/"><meta property="og:site_name" content="Gordon Burgett | Director of Technology Development"><meta property="og:title" content="Hosting Reclaimed"><meta property="og:description" content="Here’s another technical post for y’all!
I had some time this past weekend, so I took a look into the website I made a year ago for Reclaimed. The old version was made with Locomotive CMS, and hosted on Locomotive hosting. It was a good choice at the time, because we needed something fast. We wanted to deploy it before the 2015 super bowl.
I’d previously looked into moving it to Wordpress or Drupal, but that would basically require redoing the whole site. More work than I’m willing to put in. But, just this past weekend, Locomotive v3 came out. I decided to try hosting it myself, because $20/mo is just a bit too much to be paying for a simple website like this. Plus, it would be fun! (or so I thought.)"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="archive"><meta property="article:published_time" content="2016-01-19T21:31:01+01:00"><meta property="article:modified_time" content="2016-01-19T21:31:01+01:00"><meta property="article:tag" content="Reclaimed"><meta property="article:tag" content="Development"><meta property="article:tag" content="Docker"><meta name=twitter:card content="summary"><meta name=twitter:title content="Hosting Reclaimed"><meta name=twitter:description content="Here’s another technical post for y’all!
I had some time this past weekend, so I took a look into the website I made a year ago for Reclaimed. The old version was made with Locomotive CMS, and hosted on Locomotive hosting. It was a good choice at the time, because we needed something fast. We wanted to deploy it before the 2015 super bowl.
I’d previously looked into moving it to Wordpress or Drupal, but that would basically require redoing the whole site. More work than I’m willing to put in. But, just this past weekend, Locomotive v3 came out. I decided to try hosting it myself, because $20/mo is just a bit too much to be paying for a simple website like this. Plus, it would be fun! (or so I thought.)"><link rel=stylesheet href=/bootstrap-5/css/bootstrap.min.css media=all><link rel=stylesheet href=/css/header.css media=all><link rel=stylesheet href=/css/footer.css media=all><link rel=stylesheet href=/css/theme.css media=all><style>:root{--text-color:#343a40;--text-secondary-color:#6c757d;--text-link-color:#007bff;--background-color:#eaedf0;--secondary-background-color:#64ffda1a;--primary-color:#007bff;--secondary-color:#f8f9fa;--text-color-dark:#e4e6eb;--text-secondary-color-dark:#b0b3b8;--text-link-color-dark:#ffffff;--background-color-dark:#18191a;--secondary-background-color-dark:#212529;--primary-color-dark:#ffffff;--secondary-color-dark:#212529}body{font-size:1rem;font-weight:400;line-height:1.5;text-align:left}html{background-color:var(--background-color)!important}body::-webkit-scrollbar{height:0;width:8px;background-color:var(--background-color)}::-webkit-scrollbar-track{border-radius:1rem}::-webkit-scrollbar-thumb{border-radius:1rem;background:#b0b0b0;outline:1px solid var(--background-color)}#search-content::-webkit-scrollbar{width:.5em;height:.1em;background-color:var(--background-color)}</style><link rel=stylesheet href=/css/custom.css type=text/css><script src=https://code.jquery.com/jquery-3.7.1.slim.min.js integrity="sha256-kmHvs0B+OpCW5GVHUNjv9rOmY0IvSIRcf7zGUDTDQM8=" crossorigin=anonymous></script><script src=/js/custom.js type=text/javascript></script><meta name=description content><link rel=stylesheet href=/css/single.css><script defer src=/fontawesome-6/all-6.4.2.js></script><title>Hosting Reclaimed | Gordon Burgett | Director of Technology Development</title></head><body class=light><script>let localStorageValue=localStorage.getItem("pref-theme"),mediaQuery=window.matchMedia("(prefers-color-scheme: dark)").matches;switch(localStorageValue){case"dark":document.body.classList.add("dark");break;case"light":document.body.classList.remove("dark");break;default:mediaQuery&&document.body.classList.add("dark");break}</script><header id=profileHeader><nav class="pt-3 navbar navbar-expand-lg animate"><div class="container-fluid mx-xs-2 mx-sm-5 mx-md-5 mx-lg-5"><a class="navbar-brand primary-font text-wrap" href=/>Gordon Burgett
</a><button class=navbar-toggler type=button data-bs-toggle=collapse data-bs-target=#navbarContent aria-controls=navbarContent aria-expanded=false aria-label="Toggle navigation"><svg aria-hidden="true" height="24" viewBox="0 0 16 16" width="24" data-view-component="true"><path fill-rule="evenodd" d="M1 2.75A.75.75.0 011.75 2h12.5a.75.75.0 110 1.5H1.75A.75.75.0 011 2.75zm0 5A.75.75.0 011.75 7h12.5a.75.75.0 110 1.5H1.75A.75.75.0 011 7.75zM1.75 12a.75.75.0 100 1.5h12.5a.75.75.0 100-1.5H1.75z"/></svg></button><div class="collapse navbar-collapse text-wrap primary-font" id=navbarContent><ul class="navbar-nav ms-auto text-center"><li class="nav-item navbar-text"><a class=nav-link href=/#projects aria-label=projects>Projects</a></li><li class="nav-item navbar-text"><a class=nav-link href=/posts title="Blog posts">Blog</a></li><li class="nav-item navbar-text"><a class=nav-link href=/albania title=Albania>Albania</a></li><li class="nav-item navbar-text"><a class=nav-link href=/archive title=Archive>Archive</a></li><li class="nav-item navbar-text"><div class=text-center><button id=theme-toggle><svg id="moon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></li></ul></div></div></nav></header><div id=content><section id=single><div class=container><div class="row justify-content-center"><div class="col-sm-12 col-md-12 col-lg-9"><div class=pr-lg-4><div class="title mb-5"><h1 class="text-center mb-4">Hosting Reclaimed</h1><div class=text-center>Jan 19, 2016
<span id=readingTime>min read</span></div></div><article class="page-content p-2"><p>Here&rsquo;s another technical post for y&rsquo;all!</p><p>I had some time this past weekend, so I took a look into the website I made a year ago for <a href=http://www.reclaimed431.org>Reclaimed</a>. The old version was made with <a href=http://locomotivecms.com/>Locomotive CMS</a>, and hosted on <a href=http://www.locomotivehosting.com>Locomotive hosting</a>. It was a good choice at the time, because we needed something fast. We wanted to deploy it before the 2015 super bowl.</p><p>I&rsquo;d previously looked into moving it to Wordpress or Drupal, but that would basically require redoing the whole site. More work than I&rsquo;m willing to put in. But, just this past weekend, <a href=http://locomotive.works/>Locomotive v3</a> came out. I decided to try hosting it myself, because $20/mo is just a bit too much to be paying for a simple website like this. Plus, it would be fun! (or so I thought.)</p><p>Follow along in another tab with my repo: <a href=https://github.com/gburgett/locomotive_engine>https://github.com/gburgett/locomotive_engine</a></p><p>First things first, I&rsquo;ve learned from past mistakes, anytime you&rsquo;re installing open source software make sure you do it in a Linux VM. Too often open source stuff, especially ruby (oh how I loathe you now), only works on OSX and Linux.</p><p>The second thing I&rsquo;ve learned from past mistakes is always have a repeatable build of your environment. My go-to nowadays is Vagrant and Docker. So I hacked a simple <a href=https://github.com/gburgett/locomotive_engine/blob/master/Vagrantfile>Vagrantfile</a> and <a href=https://github.com/gburgett/locomotive_engine/blob/master/provision.sh>provisioning script</a> which just sets up docker and docker-compose. <code>vagrant up</code>!</p><h2 id=ok-now-we-can-get-started>OK now we can get started!</h2><p>So now that I have a linux system, I need to start building the environment that hosts the LocomotiveCMS engine. Following along from <a href=https://locomotive-v3.readme.io/docs/getting-started-with-locomotive>this guide</a>, I built my environment from the <code>rails:4</code> base. I created the rails app and installed the &rsquo;locomotivecms&rsquo; ruby gem, then set the command to run the server:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-docker data-lang=docker><span style=display:flex><span><span style=color:#66d9ef>FROM</span><span style=color:#e6db74> rails:4</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>MAINTAINER</span><span style=color:#e6db74> gordon.burgett@gmail.com</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># create the rails app, add locomotivecms as a dependency, install all the gems</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> rails new engine --skip-bundle --skip-active-record<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>WORKDIR</span><span style=color:#e6db74> engine/</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> bundle inject <span style=color:#e6db74>&#39;locomotivecms&#39;</span> <span style=color:#e6db74>&#39;~&gt; 3.0.0&#39;</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> bundle install <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	 bundle exec rails generate locomotive:install <span style=color:#f92672>&amp;&amp;</span> <span style=color:#ae81ff>\
</span></span></span><span style=display:flex><span><span style=color:#ae81ff></span>	 bundle install<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>EXPOSE</span><span style=color:#e6db74> 8080</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>CMD</span> bundle exec rails server -p <span style=color:#ae81ff>8080</span><span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p>Using docker-compose, I connected my engine image to mongoDB:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>engine</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>build</span>: <span style=color:#ae81ff>engine/</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>   - <span style=color:#e6db74>&#34;8080:8080&#34;</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>links</span>:
</span></span><span style=display:flex><span>   - <span style=color:#ae81ff>db</span>
</span></span><span style=display:flex><span><span style=color:#f92672>db</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>image</span>: <span style=color:#ae81ff>mongo:3</span>
</span></span></code></pre></div><p><code>docker-compose up</code> and&mldr; can&rsquo;t connect. But I can connect if I get into the docker image. It must be running in development mode and only accepting connections to localhost. Time for some research!</p><h2 id=several-hours-of-googling-later>Several hours of googling later&mldr;</h2><p>Apparently the standard way to set up a rails app is to use nginx in front, and proxy through a unix socket. So, time to set all that up! This was a pain. First, even installing nginx required a non-trivial script which I found somewhere:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#! /bin/bash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>nginx<span style=color:#f92672>=</span>stable <span style=color:#75715e># use nginx=development for latest development version</span>
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#34;deb http://ppa.launchpad.net/nginx/</span>$nginx<span style=color:#e6db74>/ubuntu lucid main&#34;</span> &gt; /etc/apt/sources.list.d/nginx-$nginx-lucid.list
</span></span><span style=display:flex><span>apt-key adv --keyserver keyserver.ubuntu.com --recv-keys C300EE8C
</span></span><span style=display:flex><span>apt-get update -y
</span></span><span style=display:flex><span>apt-get install -y nginx
</span></span></code></pre></div><p>And there&rsquo;s a lot of conflicting info on how to set up your nginx configuration to proxy. For the most part, I just needed to set up the &ldquo;upstream&rdquo; section, define it later as a location, and proxy to it. I decided I&rsquo;d have it first look for static assets in the <code>./public</code> folder, hence the <code>try_files</code> directive. <a href=https://github.com/gburgett/locomotive_engine/blob/master/engine/nginx.conf>Here it is</a>:</p><pre tabindex=0><code class=language-conf data-lang=conf>http {
  # tell nginx where to find the ruby engine
  upstream engine {
    server unix:///var/run/puma.sock fail_timeout=0;
  }

  server {
    listen 8080;
    server_name engine;

    # serve out of the public directory
    root /engine/public;

    # try in order: {uri}/index.html, static assets, proxy to engine
    try_files $uri/index.html $uri @engine;

    # define settings used for proxying
    location @engine {
      proxy_set_header Host $host;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

      proxy_pass http://engine; #refs the upstream defined above
    }

    # 500 level error pages
    error_page 500 502 503 504 /500.html;
  }
}
</code></pre><p>I also had to tell the ruby server to listen on that unix socket, so I added the <a href=https://github.com/gburgett/locomotive_engine/blob/master/engine/config/puma.rb>puma.rb config file</a>. The crucial line:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span>bind <span style=color:#e6db74>&#39;unix:///var/run/puma.sock&#39;</span>  <span style=color:#75715e># nginx will proxy to this socket</span>
</span></span></code></pre></div><p>Since we now have 2 processes in this container, I need <code>supervisord</code> to coordinate them. <a href=https://github.com/gburgett/locomotive_engine/blob/master/engine/supervisord.conf>My supervisord.conf</a> is mostly pulled from some examples I found (you can see the full thing in the repo), here&rsquo;s the critical stuff:</p><pre tabindex=0><code class=language-conf data-lang=conf>[supervisord]
nodaemon=true

[program:rails]
command=puma -C ./config/puma.rb config.ru
directory=/engine/
...

[program:nginx]
command = /usr/sbin/nginx
...
</code></pre><p>And of course nginx can&rsquo;t run as a daemon anymore so you have to add <code>daemon off;</code> at the top of nginx.conf.</p><p>So that all has to get back into the Dockerfile. Here&rsquo;s the lines:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-docker data-lang=docker><span style=display:flex><span><span style=color:#75715e># we need nginx</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> install_nginx.sh install_nginx.sh<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> /bin/bash install_nginx.sh <span style=color:#f92672>&amp;&amp;</span> rm install_nginx.sh<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># and supervisor</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> apt-get install -y supervisor<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span>...<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># copy all the config files into the image</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> supervisord.conf /etc/supervisor/conf.d/supervisord.conf<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> nginx.conf /etc/nginx/nginx.conf<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>COPY</span> config config<span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#75715e># start by running supervisord</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>CMD</span> [<span style=color:#e6db74>&#34;/usr/bin/supervisord&#34;</span>]<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p>Annndd&mldr; minor success! I can access the page from outside!</p><iframe width=640 height=360 src=https://www.youtube.com/embed/YQHsXMglC9A frameborder=0 allowfullscreen></iframe><h2 id=fixing-the-assets>Fixing the assets</h2><p>I was getting the HTML, but all the javascripts, css, and images were not loading. The browser was being redirected to the sign-in page when it tried to load them. Hmm&mldr; is nginx supposed to be serving these?</p><p>Several more (ok, maybe 1 and a half) hours of googling later, and apparently you&rsquo;re supposed to precompile assets in the rails asset pipeline. So, let&rsquo;s add that to the docker image:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-docker data-lang=docker><span style=display:flex><span><span style=color:#75715e># precompile all the assets so nginx can serve them</span><span style=color:#960050;background-color:#1e0010>
</span></span></span><span style=display:flex><span><span style=color:#960050;background-color:#1e0010></span><span style=color:#66d9ef>RUN</span> RAILS_ENV<span style=color:#f92672>=</span>production SECRET_KEY_BASE<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;foo&#39;</span> bin/rake assets:precompile<span style=color:#960050;background-color:#1e0010>
</span></span></span></code></pre></div><p>And now&mldr; the assets are serving but the browser isn&rsquo;t displaying them. For some reason, they&rsquo;re all being served as MIME type text/plain? I thought nginx understood javascript and css files ought to be served as the correct MIME types?</p><p>More googling came up with this missing piece: nginx has a special file that has to be included in it&rsquo;s configuration to tell it about MIME types.</p><pre tabindex=0><code># include this so that nginx doesn&#39;t serve everything as text/plain
include /etc/nginx/mime.types;
</code></pre><p>Include that, rebuild, and SUCCESS! I&rsquo;m seeing it the way it should be!</p><p><img alt="LocomotiveCMS 3.0 homepage" src=/images/2016/locomotive_3_home.png></p><h2 id=now-to-put-it-on-the-server>Now to put it on the server</h2><p>Since I have a dockerfile, it&rsquo;s fairly trivial to set up a <a href=https://hub.docker.com/r/gordonburgett/locomotive_engine/>repo on dockerhub</a>. I even set up an automatic build to trigger whenever I push to github. Now I can set up my AWS server to run it.</p><p>I changed up the HAProxy configuration on my AWS server to redirect incoming requests for reclaimed.gordonburgett.net to port 8180. I had previously set up my EC2 instance to connect to the &ldquo;default&rdquo; cluster in ECS, so I just needed to configure ECS to fire up my docker containers.</p><p><img alt="ECS task definition dashboard" src=/images/2016/ecs_task_dash.png></p><p>One thing to make sure of is that the total memory allocations don&rsquo;t top the available memory of the system, or else ECS won&rsquo;t be able to place the containers. So unfortunately Locomotive gets a rather low allocation, only 256MB.</p><p>I also had to remember to link the engine container to the DB container so they can talk, and to mount the mongodb data directory onto the disk so it won&rsquo;t be destroyed whenever I redeploy the system.</p><p>I&rsquo;ve put my secret keys in environment variables (which is why I won&rsquo;t show you the whole configuration). But you&rsquo;ve seen the core parts in the above screenshot.</p><p>Last thing to do is define a service with that task and wait for it to spin up!</p><p><img alt="ECS service definition" src=/images/2016/ecs_locomotive_service.png></p><p>Since I have HAProxy running on my EC2 instance, I don&rsquo;t need to pay $15/mo for a load balancer. I just mounted port 8180 in the task definition, and HAProxy sends traffic to that port.</p><p>And it worked! I created an account on the locomotive engine & set about uploading my site. That was a bit more of a pain than I thought.</p><h2 id=uploading-the-site>Uploading the site</h2><p>I needed to be able to run the upload tool, Wagon. Some time ago I had tried installing it on my windows machine and that was a huge pain. So again we go to Vagrant!</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ruby data-lang=ruby><span style=display:flex><span><span style=color:#66d9ef>Vagrant</span><span style=color:#f92672>.</span>require_version <span style=color:#e6db74>&#34;&gt;= 1.3.5&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>Vagrant</span><span style=color:#f92672>.</span>configure(<span style=color:#ae81ff>2</span>) <span style=color:#66d9ef>do</span> <span style=color:#f92672>|</span>config<span style=color:#f92672>|</span>
</span></span><span style=display:flex><span>  config<span style=color:#f92672>.</span>vm<span style=color:#f92672>.</span>provider <span style=color:#e6db74>&#34;virtualbox&#34;</span> <span style=color:#66d9ef>do</span> <span style=color:#f92672>|</span>v<span style=color:#f92672>|</span> 
</span></span><span style=display:flex><span>  	v<span style=color:#f92672>.</span>memory <span style=color:#f92672>=</span> <span style=color:#ae81ff>2048</span>
</span></span><span style=display:flex><span>    v<span style=color:#f92672>.</span>customize <span style=color:#f92672>[</span><span style=color:#e6db74>&#34;setextradata&#34;</span>, <span style=color:#e6db74>:id</span>, <span style=color:#e6db74>&#34;VBoxInternal2/SharedFoldersEnableSymlinksCreate//vagrant&#34;</span>, <span style=color:#e6db74>&#34;1&#34;</span><span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>end</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  config<span style=color:#f92672>.</span>vm<span style=color:#f92672>.</span>box <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;ubuntu/vivid64&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  config<span style=color:#f92672>.</span>vm<span style=color:#f92672>.</span>network <span style=color:#e6db74>&#34;forwarded_port&#34;</span>, <span style=color:#e6db74>guest</span>: <span style=color:#ae81ff>3333</span>, <span style=color:#e6db74>host</span>: <span style=color:#ae81ff>3333</span>
</span></span><span style=display:flex><span>  config<span style=color:#f92672>.</span>vm<span style=color:#f92672>.</span>network <span style=color:#e6db74>&#34;forwarded_port&#34;</span>, <span style=color:#e6db74>guest</span>: <span style=color:#ae81ff>35729</span>, <span style=color:#e6db74>host</span>: <span style=color:#ae81ff>35729</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  config<span style=color:#f92672>.</span>vm<span style=color:#f92672>.</span>provision <span style=color:#e6db74>&#34;file&#34;</span>, <span style=color:#e6db74>source</span>: <span style=color:#e6db74>&#34;~/.gitconfig&#34;</span>, <span style=color:#e6db74>destination</span>: <span style=color:#e6db74>&#34;~/.gitconfig&#34;</span>
</span></span><span style=display:flex><span>  config<span style=color:#f92672>.</span>vm<span style=color:#f92672>.</span>provision <span style=color:#e6db74>&#34;shell&#34;</span>, <span style=color:#e6db74>path</span>: <span style=color:#e6db74>&#34;./provision.sh&#34;</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>end</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#75715e># provision.sh</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#install ruby</span>
</span></span><span style=display:flex><span>curl -o rubystack-2.3.0-0-dev.run https://downloads.bitnami.com/files/stacks/rubystack/2.3.0-0/bitnami-rubystack-2.3.0-0-dev-linux-x64-installer.run
</span></span><span style=display:flex><span>chmod +x rubystack-2.3.0-0-dev.run
</span></span><span style=display:flex><span>./rubystack-2.3.0-0-dev.run --mode unattended --disable-components varnish,phpmyadmin,rvm
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#install ruby dev headers</span>
</span></span><span style=display:flex><span>apt-get install -y g++ ruby-dev zlib1g-dev
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>#install wagon</span>
</span></span><span style=display:flex><span>gem install locomotivecms_wagon
</span></span></code></pre></div><p>The difficult part here was installing Ruby. They do not like to make it easy. I am downloading Bitnami&rsquo;s Ruby Stack & running that, then installing wagon using the &ldquo;gem&rdquo; tool.</p><p>I kept getting an error when installing wagon, because it was trying to build some native extensions. That was really frustrating, it took me several hours to figure out (fortunately I could work parallel with the above efforts). The critical line was installing ruby-dev, g++ and zlib1g-dev. After installing all those it would finally compile and install wagon.</p><p>The wagon docs aren&rsquo;t that great, they assume a certain knowledge of ruby. Well I&rsquo;ve certainly gained enough of that over this experience. I managed to push to my server using this command:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>wagon auth &lt;my-email&gt;@gmail.com &lt;my-password&gt; http://reclaimed.gordonburgett.net
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>wagon deploy reclaimed.gordonburgett.net
</span></span></code></pre></div><p>It still prompted me for several questions, including my password again, and I&rsquo;m not entirely sure where all that config data is stored. But it worked!</p><h2 id=time-to-celebrate>Time to celebrate!</h2><p>I&rsquo;m glad it worked. We maybe won&rsquo;t want to shift over to this setup, but at least I learned a lot about rails. It was a fun excercise.</p><p><img alt="Reclaimed hosted on my own server" src=/images/2016/reclaimed_header.png></p></article></div></div><div class="col-sm-12 col-md-12 col-lg-3"><div id=stickySideBar class=sticky-sidebar><aside class=toc><h5>Table Of Contents</h5><div class=toc-content><nav id=TableOfContents><ul><li><a href=#ok-now-we-can-get-started>OK now we can get started!</a></li><li><a href=#several-hours-of-googling-later>Several hours of googling later&mldr;</a></li><li><a href=#fixing-the-assets>Fixing the assets</a></li><li><a href=#now-to-put-it-on-the-server>Now to put it on the server</a></li><li><a href=#uploading-the-site>Uploading the site</a></li><li><a href=#time-to-celebrate>Time to celebrate!</a></li></ul></nav></div></aside><aside class=tags><h5>Tags</h5><ul class="tags-ul list-unstyled list-inline"><li class=list-inline-item><a href=http://www.gordonburgett.net/tags/reclaimed target=_blank>reclaimed</a></li><li class=list-inline-item><a href=http://www.gordonburgett.net/tags/development target=_blank>Development</a></li><li class=list-inline-item><a href=http://www.gordonburgett.net/tags/docker target=_blank>docker</a></li></ul></aside><aside class=social><h5>Share</h5><div class=social-content><ul class=list-inline><li class="list-inline-item text-center"><a target=_blank href="https://www.linkedin.com/shareArticle?mini=true&url=http%3a%2f%2fwww.gordonburgett.net%2farchive%2f2016%2f01_hosting_reclaimed%2f"><i class="fab fa-linkedin"></i></a></li><li class="list-inline-item text-center"><a target=_blank href="https://twitter.com/share?text=Hosting%20Reclaimed&url=http%3a%2f%2fwww.gordonburgett.net%2farchive%2f2016%2f01_hosting_reclaimed%2f"><i class="fab fa-twitter"></i></a></li><li class="list-inline-item text-center"><a target=_blank href="https://api.whatsapp.com/send?text=Hosting%20Reclaimed: http%3a%2f%2fwww.gordonburgett.net%2farchive%2f2016%2f01_hosting_reclaimed%2f"><i class="fab fa-whatsapp"></i></a></li><li class="list-inline-item text-center"><a target=_blank href='mailto:?subject=Hosting%20Reclaimed&amp;body=Check%20out%20this%20site http%3a%2f%2fwww.gordonburgett.net%2farchive%2f2016%2f01_hosting_reclaimed%2f'><i class="fa fa-envelope"></i></a></li></ul></div></aside></div></div></div><div class=row><div class="col-sm-12 col-md-12 col-lg-9 p-4"></div></div></div><button class="p-2 px-3" onclick=topFunction() id=topScroll>
<i class="fas fa-angle-up"></i></button></section><div class=progress><div id=scroll-progress-bar class=progress-bar role=progressbar aria-valuenow=0 aria-valuemin=0 aria-valuemax=100></div></div><script src=/js/scrollProgressBar.js></script><script>var topScroll=document.getElementById("topScroll");window.onscroll=function(){scrollFunction()};function scrollFunction(){document.body.scrollTop>20||document.documentElement.scrollTop>20?topScroll.style.display="block":topScroll.style.display="none"}function topFunction(){document.body.scrollTop=0,document.documentElement.scrollTop=0}let stickySideBarElem=document.getElementById("stickySideBar"),stickyNavBar=!1;if(stickyNavBar){let e=document.getElementById("profileHeader"),t=e.offsetHeight+15;stickySideBarElem.style.top=t+"px"}else stickySideBarElem.style.top="50px"</script><script src=/js/readingTime.js></script></div><footer><div class="text-center pt-2"></div><div class="container py-4"><div class="row justify-content-center"><div class="col-md-4 text-center">&copy; 2024 All Rights Reserved<div class=text-secondary>Made with
<span class=text-danger>&#10084;
</span>and
<a href=https://github.com/gurusabarish/hugo-profile target=_blank title="Designed and developed by gurusabarish">Hugo Profile</a></div></div></div></div></footer><script src=/bootstrap-5/js/bootstrap.bundle.min.js></script><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))});var tooltipTriggerList=[].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]')),tooltipList=tooltipTriggerList.map(function(e){return new bootstrap.Tooltip(e)})</script><section id=search-content class=py-2><div class=container id=search-results></div></section></body></html>